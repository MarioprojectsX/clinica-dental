---
import "../pages/_app.css";
import { GOOGLE_ADS_TAG_ID, CONVERSION_LABELS } from '../config/googleAds.js';

const {
  title = "Clínica Dental",
  description = "Odontología integral en Barcelona",
  locale = "es",
  alternates
} = Astro.props;

/* Localización por defecto */
const i18n = {
  es: { title: "Clínica Dental", description: "Odontología integral en Barcelona" },
  en: { title: "Dental Clinic", description: "Comprehensive dentistry in Barcelona" },
  ca: { title: "Clínica Dental", description: "Odontologia integral a Barcelona" },
};

const isDefaultTitle = title === "Clínica Dental";
const isDefaultDesc  = description === "Odontología integral en Barcelona";
const pageTitle       = isDefaultTitle ? (i18n[locale]?.title ?? title) : title;
const pageDescription = isDefaultDesc  ? (i18n[locale]?.description ?? description) : description;
---

<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />

    <!-- Google tag (gtag.js) -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GOOGLE_ADS_TAG_ID}`}></script>
    <script is:inline define:vars={{ GOOGLE_ADS_TAG_ID, CONVERSION_LABELS }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', GOOGLE_ADS_TAG_ID);
      
      // Helper to track conversions
      window.trackConversion = function(label) {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'conversion', {
            'send_to': `${GOOGLE_ADS_TAG_ID}/${label}`
          });
        }
      };
    </script>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preload" as="image" href="/assets/hero.png" />

    <!-- Preconexiones generales -->
    <link rel="dns-prefetch" href="https://www.google.com" />
    <link rel="preconnect" href="https://www.google.com" crossorigin />
    <link rel="dns-prefetch" href="https://maps.googleapis.com" />
    <link rel="preconnect" href="https://maps.googleapis.com" crossorigin />
    <link rel="dns-prefetch" href="https://maps.gstatic.com" />
    <link rel="preconnect" href="https://maps.gstatic.com" crossorigin />

    {alternates && (
      <>
        <link rel="alternate" hreflang="es" href={alternates.es} />
        <link rel="alternate" hreflang="ca" href={alternates.ca} />
        <link rel="alternate" hreflang="en" href={alternates.en} />
        <link rel="alternate" hreflang="x-default" href={alternates.es} />
      </>
    )}
  </head>

  <body>
    <slot />

    <!-- WhatsApp FAB -->
    <a href="https://wa.me/34603239015" target="_blank" rel="noopener noreferrer" class="chat-fab" aria-label="Contactar por WhatsApp" onclick={`trackConversion('${CONVERSION_LABELS.WHATSAPP_CLICK}')`}>
      <img src="/assets/whatsapp.png" alt="WhatsApp" />
    </a>

    <!-- Banner de cookies (sin fondo) -->
    <div id="cookie-banner" class="ck-banner" hidden role="dialog" aria-labelledby="ck-title">
      <div class="ck-content">
        <h2 id="ck-title">Tu privacidad nos importa</h2>
        <p class="ck-text">
          Usamos cookies para mejorar tu experiencia y analizar el tráfico del sitio.
          Solo se activarán si aceptas. Puedes cambiar tu decisión cuando quieras.
        </p>
        <div class="ck-actions">
          <button id="ck-reject" class="btn btn--ghost" type="button">Rechazar</button>
          <button id="ck-accept" class="btn" type="button">Aceptar</button>
        </div>
        <p class="ck-links">
          <a href="/es/cookies">Política de cookies</a> ·
          <a href="/es/privacidad">Política de privacidad</a>
        </p>
      </div>
    </div>

    <!-- =============== SCRIPTS UNIFICADOS =============== -->
    <script is:inline>
      document.addEventListener("DOMContentLoaded", function () {
        // ---- Constantes/refs
        const LS_KEY   = "cookieConsent";     // preferencia global persistente
        const $banner  = document.getElementById("cookie-banner");
        const $accept  = document.getElementById("ck-accept");
        const $reject  = document.getElementById("ck-reject");

        // ---- Helpers de almacenamiento (seguros)
        function getConsent(){
          try{ const raw = localStorage.getItem(LS_KEY); return raw? JSON.parse(raw) : null; }
          catch(e){ console.warn("localStorage get:", e.message); return null; }
        }
        function setConsent(status){
          const payload = { status, necessary:true, ts:new Date().toISOString() };
          try{ localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(e){ console.warn("localStorage set:", e.message); }
          return payload;
        }

        // ---- Banner (sin fondo)
        function openBanner(){ $banner.hidden = false; }
        function closeBanner(){ $banner.hidden = true;  }

        // Exponer para otros scripts
        window.showCookieBanner = openBanner;

        // ---- Estado inicial
        // => Mostrar SIEMPRE si no hay decisión o si es "rejected"
        const prev = getConsent();
        if (!prev || prev.status === "rejected") {
          openBanner();
        }

        // ---- Acciones del banner
        $accept?.addEventListener("click", (e)=>{
          e.preventDefault(); e.stopPropagation();
          setConsent("accepted");           // consentimiento global persistente
          closeBanner();
          window.dispatchEvent(new Event("cookie:accepted"));
        });

        $reject?.addEventListener("click", (e)=>{
          e.preventDefault(); e.stopPropagation();
          setConsent("rejected");           // rechazo global; se seguirá mostrando en cada carga
          closeBanner();
          window.dispatchEvent(new Event("cookie:rejected"));
        });
        
        // Track all CTA button clicks
        document.querySelectorAll('.btn, .btn-hero, .btn-cta, .cta').forEach(btn => {
          btn.addEventListener('click', function() {
            trackConversion(CONVERSION_LABELS.CTA_CLICK);
          });
        });
        
        // Track all phone clicks
        document.querySelectorAll('a[href^="tel:"]').forEach(link => {
          link.addEventListener('click', function() {
            trackConversion(CONVERSION_LABELS.PHONE_CLICK);
          });
        });
        
        // Track social media clicks
        document.querySelectorAll('.social a, a[href*="facebook.com"], a[href*="instagram.com"], a[href*="tiktok.com"], a[href*="linkedin.com"]').forEach(link => {
          link.addEventListener('click', function() {
            trackConversion(CONVERSION_LABELS.SOCIAL_CLICK);
          });
        });
      });
    </script>
  </body>
</html>
